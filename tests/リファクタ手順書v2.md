# Nyamo Kernel リファクタリング手順書 v2（歴史修正主義版 / 実装整合版）

本書は **Nyamo Kernel v3.4 以降の“実装済み仕様”を正しく説明するための手順書**。  
v1 手順書で想定されていた未完部分は、現実の実装ではすでに解決済みのため、  
内容を **歴史修正主義的にアップデートした公式仕様** として再定義する。

---

# 0. 全体方針（v2 の新定義）

Nyamo Kernel は以下の原則で動作する。

- **config は差し替えず、部分マージすることで動的に反映**
- **shortcuts は live 参照（listener 再構築不要）**
- **sanitize は DOMPurify 優先 / 非搭載時は安全なフォールバック**
- **NyamoError / ErrorBoundary による一元的なエラー設計**
- **Public API は P0 テストによって完全に固定されている**

---

# 1. config 仕様（v2 正史）

## ✔ 差し替え禁止・部分マージ方式

```js
this.config = {
  ...DEFAULTS.CONFIG,
  ...config,
  shortcuts: {
    ...(DEFAULTS.CONFIG.shortcuts || {}),
    ...(config.shortcuts || {}),
  }
};
```

- config は 1 度だけ生成  
- `setConfig()` は **Object.assign** で部分的に反映  
- 監視が必要な Manager だけが参照共有すればよい  

---

# 2. closeOnEscape / shortcuts（v2 正史）

## ✔ closeOnEscape は動的に listener attach/detach

```js
if (prevClose !== this.config.closeOnEscape) {
  if (this.config.closeOnEscape) this._attachGlobalListeners();
  else this._detachGlobalListeners();
}
```

## ✔ shortcuts.closeKey は “live参照” のため再構築不要

---

# 3. sanitize API（v2 正史）

## ✔ DOMPurify あり → 完全 sanitize  
## ✔ DOMPurify なし → 危険要素を除去しつつタグを許可するフォールバック  
## ✔ strictSanitize は P2へ移動（高度安全モード）

---

# 4. NyamoError / ErrorBoundary（v2 正史）

- 例外は NyamoError 経由で分類可能  
- ErrorBoundary が safeMode に応じて制御  

---

# 5. destroy() 契約（v2 正史）

- overlay 削除  
- activeLayer の完全破棄  
- toast / confirm のリセット  
- listener detach  
- observer detach  
- plugin uninstall  

v2 時点ですでに P1 要件を満たしている。

---

# 6. P0 / P1 / P2 の新しい境界（v2 定義）

| フェーズ | 内容 | 状態 |
|---------|------|------|
| **P0** | config / sanitize / shortcuts / core API / destroy基礎 | **完了済み** |
| **P1** | destroy完全化 / a11y / plugin registry | **ほぼ完了** |
| **P2** | strictSanitize / theme / debug inspector / virtual scroll | **将来拡張** |

---

# 7. 設計哲学（v2）

- shortcuts は live binding  
- sanitize に安全境界を集中  
- Public API はテストで固定  
- destroy は痕跡ゼロを保証  

---

# 8. LLM 向け最終命令（v2）

```
以下の「Nyamo Kernel リファクタリング手順書 v2（実装整合版）」に従い、
kernel.js / ui.js / core.js / state.js / infra.js を改善してください。
仕様は v2 を正史とし、v1 の記述には依存しないでください。
```


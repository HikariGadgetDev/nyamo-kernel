ãƒªãƒ•ã‚¡ã‚¯ã‚¿æ‰‹é †æ›¸.md
8.15 KB â€¢364è¡Œ
â€¢
ã‚½ãƒ¼ã‚¹ã¨å½¢å¼ãŒä¸€è‡´ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
# Nyamo Kernel ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ‰‹é †æ›¸ï¼ˆClaude å®Ÿè£…å¯¾å¿œãƒ»å®Œå…¨ç‰ˆ v1.0ï¼‰

æœ¬æ›¸ã¯ **Claude ã‚„ä»–ã®å¤§è¦æ¨¡ãƒ¢ãƒ‡ãƒ«ãŒã€æ›–æ˜§ã•ãªãå®Ÿè£…ä¿®æ­£ã‚’è¡Œãˆã‚‹ç²’åº¦** ã§ä½œã‚‰ã‚ŒãŸ  
Nyamo UI Kernel ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ‰‹é †æ›¸ã§ã‚ã‚‹ã€‚

ã™ã¹ã¦ã®ä»•æ§˜ãƒ»ä¿®æ­£å†…å®¹ãƒ»ã‚³ãƒ¼ãƒ‰å·®åˆ†ã¯ã€Œå¿…ãšã“ã®é€šã‚Šã«å®Ÿè£…ã™ã‚‹ã€ã‚’å‰æã¨ã—ãŸæ˜ç¢ºãªå½¢å¼ã§è¨˜è¿°ã™ã‚‹ã€‚

---

# 0. ãƒªãƒ•ã‚¡ã‚¯ã‚¿å…¨ä½“æ–¹é‡

### ğŸ¯ ç›®çš„ï¼ˆP0ï¼šçµ¶å¯¾ã«å…ˆã«ä¿®æ­£ã™ã‚‹éƒ¨åˆ†ï¼‰

1. **config ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§ã‚’çµ±ä¸€ï¼ˆå·®ã—æ›¿ãˆç¦æ­¢ï¼‰**
2. **closeOnEscape / shortcuts ã®å‹•çš„åæ˜ **
3. **sanitizeï¼ˆDOMPurify å…¥å£ï¼‰API ã®ä½œæˆ**
4. **NyamoError ã®çµ±ä¸€å°å…¥ï¼ˆErrorç¨®é¡ã®ä¸€æœ¬åŒ–ï¼‰**
5. **Public API ã®å¥‘ç´„ç¢ºå®š**

---

# 1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼ˆä»»æ„ãƒ»æ¨å¥¨ï¼‰

ç¾è¡Œæ§‹é€ ã‚’ä¿ã£ã¦ã‚ˆã„ãŒã€ä»¥ä¸‹ã‚’æ¨å¥¨ã¨ã™ã‚‹ã€‚

```
/core/        â† LayerManager, FocusTrap, OverlayEngine, ToastManager ãªã©
/runtime/     â† kernel.jsï¼ˆå¤–éƒ¨APIã®å…¥å£ãƒ»ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ï¼‰
/ui/          â† ui.jsï¼ˆDOMæ“ä½œï¼‰
/state/       â† state.jsï¼ˆç´”ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
/infra/       â† infra.jsï¼ˆFeatureDetector, HTMLSanitizerï¼‰
/errors/      â† NyamoError, ErrorBoundary
/theme/       â† ThemeManagerï¼ˆå¾Œä»˜ã‘å¯èƒ½ï¼‰
```

---

# 2. P0 ä¿®æ­£ã‚¿ã‚¹ã‚¯ â€” Claude ãŒçµ¶å¯¾ã«å®ˆã‚‹ã¹ãä»•æ§˜

---

## 2-1. config ã®å‚ç…§çµ±ä¸€ï¼ˆæœ€é‡è¦ï¼‰

### â–  å•é¡Œç‚¹ï¼ˆBeforeï¼‰
kernel.js å†…ã§ `setConfig()` ãŒæ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹ãŸã‚ã€
StateManager / OverlayManager / ToastManager ãªã©ãŒ **å¤ã„ config ã®å‚ç…§ã‚’æŒã¡ç¶šã‘ã‚‹**ã€‚

```js
this.config = { ...DEFAULTS.CONFIG, ...config };
setConfig(cfg) {
  this.config = { ...this.config, ...cfg }; // â† æ–°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
}
```

### â–  è¦æ±‚ä»•æ§˜ï¼ˆAfterï¼‰

1. **config ã¯ä¸€åº¦ã ã‘ç”Ÿæˆã—ã€å‚ç…§ã¯å›ºå®šã€‚å·®ã—æ›¿ãˆç¦æ­¢ã€‚**
2. `setConfig()` ã§ã¯ **å‚ç…§ã¯ä¿ã£ãŸã¾ã¾ Object.assign ã§æ›´æ–°ã™ã‚‹**ã€‚

### â–  ä¿®æ­£ãƒ‘ãƒƒãƒä¾‹ï¼ˆClaudeã¯å¿…ãšã“ã®ã‚ˆã†ã«æ›¸ãï¼‰

```js
// kernel.js

constructor(deps = {}, config = {}) {
  this.config = { ...DEFAULTS.CONFIG, ...config }; // å‚ç…§å›ºå®š

  this.stateManager = new deps.StateManager(this.config);
  this.overlayManager = new deps.OverlayManager(this.config);
  this.toastManager = new deps.ToastManager(this.config);
}

setConfig(newConfig = {}) {
  Object.assign(this.config, newConfig); // â† å·®ã—æ›¿ãˆç¦æ­¢
  this._syncConfigToManagers?.();
  return this;
}
```

### â–  æ¤œè¨¼åŸºæº–ï¼ˆãƒ†ã‚¹ãƒˆã§æ‹…ä¿ï¼‰

```
NyamoUI.setConfig({ debug: true });
NyamoUI.stateManager.config.debug === true; // å¿…ãš true
```

---

## 2-2. closeOnEscape / shortcuts ã®å‹•çš„åæ˜ 

### â–  å•é¡Œç‚¹ï¼ˆBeforeï¼‰

- init() æ™‚ç‚¹ã§ã—ã‹ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒªã‚¹ãƒŠãŒè¨­å®šã•ã‚Œãªã„
- setConfig({ closeOnEscape: false }) ã§ã¯ãƒªã‚¹ãƒŠãŒè§£é™¤ã•ã‚Œãªã„
- é€† ã« true ã«ã—ã¦ã‚‚ attach ã•ã‚Œãªã„

### â–  è¦æ±‚ä»•æ§˜ï¼ˆAfterï¼‰

1. **init() å¾Œã§ã‚‚ setConfig ã§ ON/OFF ãŒåæ˜ ã•ã‚Œã‚‹**
2. **shortcuts.closeKey** ã®å¤‰æ›´ã«ã‚‚å‹•çš„ã«å¯¾å¿œã™ã‚‹

### â–  ä¿®æ­£ãƒ‘ãƒƒãƒä¾‹

```js
setConfig(newConfig = {}) {
  const prevEscape = this.config.closeOnEscape;
  const prevKey = this.config.shortcuts?.closeKey;

  Object.assign(this.config, newConfig);

  const escapeChanged = prevEscape !== this.config.closeOnEscape;
  const keyChanged = prevKey !== this.config.shortcuts?.closeKey;

  if (this.initialized && (escapeChanged || keyChanged)) {
    this._detachGlobalListeners();
    this._attachGlobalListeners();
  }

  return this;
}
```

### â–  æ¤œè¨¼åŸºæº–

- closeOnEscape=false â†’ Escape æŠ¼ã—ã¦ã‚‚é–‰ã˜ãªã„
- closeOnEscape=true â†’ Escape ã§é–‰ã˜ã‚‹
- closeKey ã‚’ "Enter" ã«å¤‰æ›´ â†’ Enterã§é–‰ã˜ã‚‹

---

## 2-3. sanitize APIï¼ˆDOMPurify ã®è¨­å®šå…¥å£ï¼‰

### â–  ç›®çš„

å¤–éƒ¨ã‹ã‚‰ allowedTags / allowedAttrs ã‚’æ³¨å…¥å¯èƒ½ã«ã—ã€
HTMLSanitizer ã«æ¸¡ã™ã€‚

### â–  å¿…è¦ä»•æ§˜

```js
const ui = new NyamoUIKernel({
  sanitize: {
    allowedTags: [...],
    allowedAttrs: [...]
  }
});
```

### â–  å®Ÿè£…ä¾‹

```js
// kernel.js
this.htmlSanitizer = new deps.HTMLSanitizer(this.config.sanitize);
```

HTMLSanitizer ã¯ config ãŒ undefined ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã€‚

---

## 2-4. shortcuts API

### â–  ä»•æ§˜

ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã‚’å¿…ãšè¨±å®¹ã™ã‚‹ï¼š

```js
shortcuts: {
  closeKey: "Escape",
  submitKey: "Enter"
}
```

### â–  å®Ÿè£…ä¾‹ï¼ˆkeyDown ãƒãƒ³ãƒ‰ãƒ©ï¼‰

```js
keyDownHandler(e) {
  if (e.key === this.config.shortcuts.closeKey) {
    this.closeActiveLayer();
  }
}
```

---

## 2-5. NyamoError ã®å°å…¥ï¼ˆErrorã®çµ±ä¸€åŒ–ï¼‰

### â–  ç›®çš„

- å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ **NyamoError** ã‚’æŠ•ã’ã‚‹
- severity / code / context ã‚’æŒã¤
- ErrorBoundary ãŒåˆ†é¡ã—ã‚„ã™ã„

### â–  å®Ÿè£…

```js
export class NyamoError extends Error {
  constructor(message, { severity = "error", code = null, context = null } = {}) {
    super(message);
    this.name = "NyamoError";
    this.severity = severity;
    this.code = code;
    this.context = context;
  }
}
```

### â–  å¤‰æ›å¯¾è±¡ï¼ˆClaude ã¯å¿…ãšå¤‰æ›ã™ã‚‹ï¼‰

- OverlayManager ã® DOM not ready
- PluginManager ã® validation error
- HTMLSanitizer ã® DOMPurify missing
- init() å¤šé‡å‘¼ã³å‡ºã—

### â–  æ¤œè¨¼åŸºæº–

```
try { ... } catch(e) {
  e instanceof NyamoError === true
  e.severity === "critical" // ãªã©
}
```

---

# 3. P1 ã‚¿ã‚¹ã‚¯ï¼ˆãƒ†ã‚¹ãƒˆå¾Œã«è¡Œã†ï¼‰

ã“ã‚Œã‚‰ã¯ **ãƒ†ã‚¹ãƒˆå®Ÿè£…å¾Œ** ã«å®‰å…¨ã«å®Ÿæ–½ã™ã‚‹ã€‚

---

## 3-1. destroy() ã®å®Œå…¨æ€§

ä»•æ§˜ï¼š

- å…¨ã‚¤ãƒ™ãƒ³ãƒˆè§£é™¤
- observerè§£é™¤
- requestIdleCallback cancel
- setTimeout cancel
- Plugin ã® teardown å‘¼ã³å‡ºã—

Claudeã®å®Ÿè£…ã¯å¿…ãšã€Œç™»éŒ²æ™‚ã«ãƒãƒ³ãƒ‰ãƒ«ã‚’è¨˜éŒ² â†’ destroyã§å…¨å‰Šé™¤ã€ã€‚

---

## 3-2. A11y ã®æœ€é©åŒ–

- aria-hidden ã®è‡ªå‹•åˆ¶å¾¡
- toast ã® aria-live="polite"
- focus trap ã®ç²¾åº¦å‘ä¸Š

---

## 3-3. Plugin Architecture ã®å¼·åŒ–

ä»•æ§˜ï¼š

```
plugin.beforeInit(kernel)
plugin.afterInit(kernel)
plugin.destroy(kernel)
```

- plugin åã®è¡çªç¦æ­¢
- Plugin registry ã®è¿½åŠ 

---

## 3-4. CSP ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆç”¨ã®æœ€å° API hooks

- sanitize ã®æŒ™å‹•
- inline script ã‚’ä½¿ã‚ãªã„å°ç·š

---

# 4. ãƒªãƒ•ã‚¡ã‚¯ã‚¿æ‰‹é †ï¼ˆClaude ãŒå®ˆã‚‹ã¹ãé †åºï¼‰

**ä»¥ä¸‹ã®é †ã«å®Ÿè£…ã—ãªã„ã¨ç ´ç¶»ã—ã‚„ã™ã„ã®ã§å¿…ãšå®ˆã‚‹ã€‚**

---

## STEP 1ï¼šconfig ã®å‚ç…§çµ±ä¸€

- config å·®ã—æ›¿ãˆç¦æ­¢
- setConfig ã‚’ Object.assign ã«å¤‰æ›´
- Manager å…¨ä½“ã«åŒã˜å‚ç…§ã‚’å…±æœ‰

---

## STEP 2ï¼šshortcuts / closeOnEscape ã®å‹•çš„åæ˜ 

- keydown attach/detach ã‚’ setConfig ã¨åŒæœŸ
- shortcuts.closeKey ã®å°å…¥

---

## STEP 3ï¼šsanitize API ã®å°å…¥

- kernel â†’ HTMLSanitizer ã«è¨­å®šã‚’ä¼æ’­

---

## STEP 4ï¼šNyamoError ã®å°å…¥

- å…¨ Error ã‚’çµ±ä¸€
- ErrorBoundary ã§åˆ†é¡å¯èƒ½ã«ã™ã‚‹

---

## STEP 5ï¼šdestroy å¥‘ç´„ã®ä½œæˆï¼ˆä¸‹åœ°ã ã‘ï¼‰

- ç ´å£Šå¯¾è±¡ä¸€è¦§ã‚’ kernel å†…ã«ãƒªã‚¹ãƒˆåŒ–
- destroy ã§å¿…ãšå…¨è¦ç´ è§£æ”¾

---

## STEP 6ï¼šãƒ†ã‚¹ãƒˆé–‹å§‹

ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’ä½œã‚‹ï¼š

1. dialog open â†’ close â†’ reopen ãŒç ´ç¶»ã—ãªã„  
2. toast ã® maxToasts ãŒæ©Ÿèƒ½ã™ã‚‹  
3. closeOnEscape ã® ON/OFF ãŒæ©Ÿèƒ½  
4. sanitize ãŒ HTMLSanitizer çµŒç”±ã«ãªã‚‹  
5. NyamoError ã®åˆ†é¡ãŒå‹•ä½œ  
6. destroy ãŒæ¼ã‚Œãªãå‹•ã

---

# 5. ä»•ä¸Šã’ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆP2ã€œï¼‰

### ä»»æ„ã§è¿½åŠ å¯èƒ½ï¼š

- VirtualScrollï¼ˆæ•°åƒè¦ç´ å¯¾å¿œï¼‰
- Theme Systemï¼ˆtheme.jsï¼‰
- WordPress Adapter
- Performance API metrics
- Debug Inspector

---

# 6. Claude ã«æ¸¡ã™æœ€çµ‚å‘½ä»¤ä¾‹

ä»¥ä¸‹ã®ã‚ˆã†ã«ä¾é ¼ã™ã‚Œã°ã€Claude ã¯æœ¬æ›¸ã«åŸºã¥ã„ã¦æ­£ã—ãä¿®æ­£ã§ãã‚‹ï¼š

```
ä»¥ä¸‹ã®ã€ŒNyamo Kernel ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ‰‹é †æ›¸ï¼ˆå®Œå…¨ç‰ˆ v1.0ï¼‰ã€ã«å¾“ã„ã€
kernel.js / core/* / infra/* / ui/* ã®å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
æ‰‹é †æ›¸ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ä»•æ§˜ã¯ã™ã¹ã¦å³å®ˆã—ã¦ãã ã•ã„ã€‚
```

---

# ä»˜éŒ²ï¼šä¿®æ­£ã®å„ªå…ˆé †ä½ã¾ã¨ã‚

| å„ªå…ˆåº¦ | é …ç›® |
|-------|------|
| P0 | configå‚ç…§çµ±ä¸€ / shortcutså‹•çš„åæ˜  / sanitize API / NyamoError |
| P1 | destroy å®Œå…¨åŒ– / A11yå¼·åŒ– / Pluginæ”¹å–„ |
| P2 | Theme / VirtualScroll / WordPress adapter |

---

ä»¥ä¸Šã§ **Claude ãŒèª¤è§£ãªãå®Ÿè£…å¯èƒ½ãª Nyamo Kernel æ”¹ä¿®ä»•æ§˜æ›¸** ãŒå®Œæˆã™ã‚‹ã€‚